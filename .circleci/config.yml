 jobs:
   build:
     docker:
       - image: 'cimg/ruby:2.7-node'
     steps:
       - checkout
       - run: sudo apt-get update
       - run: sudo apt-get install libsqlite3-dev
       - run: gem install sqlite3 -v '1.4.2' --source 'https://rubygems.org/'
       - run: bundle lock --add-platform x86-mingw32 x86-mswin32 x64-mingw32 java
       - ruby/install-deps
       - node/install-packages:
           pkg-manager: yarn
           cache-key: "yarn.lock"

   browsertest:
     docker:
       - image: 'cimg/ruby:2.7-node'
     steps:
       - checkout
       - run: sudo apt-get update
       - run: sudo apt-get install libsqlite3-dev
       - run: gem install sqlite3 -v '1.4.2' --source 'https://rubygems.org/'
       - run: bundle lock --add-platform x86-mingw32 x86-mswin32 x64-mingw32 java
       - run:
          name: Install Cypress dependencies
          command: sudo apt-get install xvfb libgtk-3-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 --fix-missing
       - run:
          name: install cypress
          command: npm install cypress --save-dev
       - run: gem install bundler:2.0.1
       - run: bundle update --bundler
       - run:
           name: Boot rails server
           command: bin/rails s
           background: true
       - run: mkdir /tmp/results
       - run: npm install --save-dev mocha mochawesome mochawesome-merge mochawesome-report-generator
       - run: # open cypress and use sample_spec.js
          name: run
          command: $(npm bin)/cypress run -- --record --spec "cypress/integration/sample_spec.js"
       - store_test_results:
           path: /tmp/results
       - store_artifacts:
           path: /tmp/results
           destination: results
   
   test:
     docker:
       - image: 'cimg/ruby:2.7-node'
       - environment:
           POSTGRES_DB: rails_blog_test
           POSTGRES_PASSWORD: ''
           POSTGRES_USER: circleci-demo-ruby
         image: 'circleci/postgres:9.5-alpine'
     environment:
       BUNDLE_JOBS: '3'
       BUNDLE_RETRY: '3'
       PGHOST: 127.0.0.1
       PGPASSWORD: ''
       PGUSER: circleci-demo-ruby
       RAILS_ENV: test
     parallelism: 3
     steps:
       - checkout
       - run: sudo apt-get update
       - run: sudo apt-get install libsqlite3-dev
       - run: gem install sqlite3 -v '1.4.2' --source 'https://rubygems.org/'
       - run: gem install rake
       - run: bundle lock --add-platform x86-mingw32 x86-mswin32 x64-mingw32 java
       - ruby/install-deps
       - node/install-packages:
           pkg-manager: yarn
           cache-key: "yarn.lock"
       - run: rake db:create && rake db:migrate
       - run:
           command: 'dockerize -wait tcp://localhost:5432 -timeout 1m'
           name: Wait for DB
       - run:
           command: 'bundle exec rails db:schema:load --trace'
           name: Database setup
       - ruby/rspec-test
       - ruby/rubocop-check


   deploy:
     docker:
       - image: 'cimg/ruby:2.7-node'
     steps:
       - checkout
       - run: sudo apt-get update
       - run: bundle lock --add-platform x86-mingw32 x86-mswin32 x64-mingw32 java
       - ruby/install-deps
       - heroku/install
       - heroku/deploy-via-git

 orbs:
   ruby: circleci/ruby@1.1.4
   node: circleci/node@2
   heroku: circleci/heroku@1.2.6
   cypress: cypress-io/cypress@1.29.0
 executors:
   ruby:
     docker:
       - image: 'cimg/ruby:2.7-node'
 version: 2.1
 workflows:
   build_and_test:
     jobs:
       - build
       - test:
           requires:
             - build
       - browsertest:
           requires:
             - build
       - cypress/run:
           build: bundle install
           executor: ruby 
           start: cd ~/project && rails server
           wait-on: http://localhost:3000
       - deploy:
           requires:
             - test
             - browsertest

         
